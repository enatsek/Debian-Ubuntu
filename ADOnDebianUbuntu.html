<!DOCTYPE html> <html> <head> <meta charset="UTF-8"></head><body><H1>ADOnDebianUbuntu:  Simple Active Directory Configuration on Debian and Ubuntu 
</H1><p> <H4><a href="javascript:myFunction('Div1')">Copyright (C) 2021 - 2023 Exforge exforge@x386.org
</a> </H4><div id="Div1" style="margin-left:1%;"><pre ># - This document is free text: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# any later version.
#
# - This document is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.
</pre> </div> </p>
<p> <H4><a href="javascript:myFunction('Div2')">0.Specs
</a> </H4><div id="Div2" style="margin-left:1%;"><pre ><B><span style="Font-Family:Verdana">#-- 0.1. Definition
</B></span># - Single Domain Active Directory infrastructure with Debian or Ubuntu 
# Servers with 2 Domain Controllers and a file server.
# - Windows workstations can join to AD.
# - No license costs except Windows workstation licences.
# - Based on the valuable documents at:
<a href="https://www.server-world.info/en/note?os=Ubuntu_18.04&p=samba&f=4" target="_blank">https://www.server-world.info/en/note?os=Ubuntu_18.04&p=samba&f=4</a>
#
<B><span style="Font-Family:Verdana">#-- 0.2. Configuration
</B></span># Domain Name: X11.XYZ
# Domain Netbios Name: X11
# First DC:    
#    srv1.x11.xyz 
#    192.168.1.224 
#    Debian 12/11 or Ubuntu 22.04/20.04 LTS Server
# Second DC:    
#    srv2.x11.xyz 
#    192.168.1.225 
#    Debian 12/11 or Ubuntu 22.04/20.04 LTS Server
# File Server: 
#    srvf.x11.xyz 
#    192.168.1.226 
#    Debian 12/11 or Ubuntu 22.04/20.04 LTS Server
# Windows workstations can connect to the domain
# 
# - On my tests I used distros uniformly. That is all servers were Debian 
# 11, Debian 12, Ubuntu 20.04, or Ubuntu 22.04. I believe the system would 
# work with nonuniform distros too, but I haven't tested it.
#
<B><span style="Font-Family:Verdana">#-- 0.3. Phases
</B></span># 0.3.1. Add First DC (srv1.x11.xyz)
# 0.3.2. Add Additional DC (srv2.x11.xyz)
# 0.3.3. AD User Management
# 0.3.4. Add a Linux File Server to the Domain (srvf.x11.xyz)
# 0.3.5. Add a Windows Computer to the Domain
#
<B><span style="Font-Family:Verdana">#-- 0.4. Preliminary Tasks
</B></span># - There are some important matters to consider. Not complying them can 
# cause some problems.
#
# 0.4.1. Choosing Domain Name and Realm
# - Actually Realm is in the domain name format and Domain Name is a single 
# word (actually Netbios Name of your domain).
# - If your company's internet domain name is example.com, then you can 
# choose your Realm and Domain Name as following:
# Realm:	EXAMPLE.COM
# Domain Name:	EXAMPLE
# - Whenever you use them, they must be UPPERCASE. Don't ask me why, that is 
# something about Micros*ft's bad design.
#
# 0.4.2. IP Address and Host Name for Domain Controllers and Domain Members
# - Domain Controllers and Domain Members should have static IP addresses. 
# There might be some ways to use DHCP but I don't know how and actually I 
# don't see any reason to use DHCP for Domain Controllers.
# - Hostname must be in the format of name.example.com (lowercase this time) 
# and due to an imcompatability with Samba and Debian/Ubuntu (Actually all 
# Debian based Linuxes) you have to erase the line starting with 127.0.1.1
# (not 127.0.0.1) from your /etc/hosts file and add the IP and hostname 
# (short and long formats) in your /etc/hosts file as in below.
#
<code><span style="Color:MediumSeaGreen">127.0.0.1	localhost
192.168.1.224	srv1.x11.xyz srv1
</span></code># 
# 0.4.3. Mixed Environment
# - You should have at least 2 DCs (Domain Controllers), you can use 1 
# Wind*ws and 1 Linux to benefit from Micros*ft's AD Management programs.
# But actually it is not necessary. I'd advice installing all DCs as Linux 
# and use any Wind*ws workstation to manage AD. You can install RSAT
# Management Tools to a Wind*ws workstation and use AD Manager programs 
# (including DNS and WINS server) from there.
#
# 0.4.4. Default Values 
# - Remember to replace all the occurences of X11, x11, X11.XYZ, and x11.xyz 
# with yours, regarding the cases. 
</pre> </div> </p>
<p> <H4><a href="javascript:myFunction('Div3')"> 1. Add First Domain Controller
</a> </H4><div id="Div3" style="margin-left:1%;"><pre ><B><span style="Font-Family:Verdana">#-- 1.0. Specs
</B></span># Domain Name:  X11
# Realm:        X11.XYZ	
# Hostname:     srv1.x11.xyz
# IP:           192.168.1.224
#
<B><span style="Font-Family:Verdana">#-- 1.1. Install required packages
</B></span><code><span style="Color:DodgerBlue">sudo apt update
</span></code><code><span style="Color:DodgerBlue">sudo apt -y install samba krb5-config winbind smbclient 
</span></code># Answers to parameter questions:
## Default Kerberos version 5 realm:
# In Capital Letters
#  X11.XYZ
## Kerberos servers for your realm:
#  srv1.x11.xyz
## Administrative server for your Kerberos realm:
#  srv1.x11.xyz
#
<B><span style="Font-Family:Verdana">#-- 1.2. Configure Samba AD DC
</B></span># 1.2.1. Backup original samba configuration
<code><span style="Color:DodgerBlue">sudo mv /etc/samba/smb.conf /etc/samba/smb.conf.original 
</span></code># 1.2.2. Run Samba Config
<code><span style="Color:DodgerBlue">sudo samba-tool domain provision
</span></code># Answers to parameter questions:
## Realm:
#  X11.XYZ
## Domain: 
#  X11
## Server Role (dc, member, standalone) &lsqb;dc&rsqb;: 
#  Just press enter
## DNS backend (SAMBA_INTERNAL,...
#  Just press enter
## DNS forwarder IP address...
#  Leave empty or enter 8.8.8.8
## Administrator password:
#  Enter a good password
#
# 1.2.3. Copy kerberos config file, stop and disable unnecessary services
<code><span style="Color:DodgerBlue">sudo cp /var/lib/samba/private/krb5.conf /etc/
</span></code><code><span style="Color:DodgerBlue">sudo systemctl stop smbd nmbd winbind systemd-resolved
</span></code><code><span style="Color:DodgerBlue">sudo systemctl disable smbd nmbd winbind systemd-resolved
</span></code><code><span style="Color:DodgerBlue">sudo systemctl unmask samba-ad-dc 
</span></code>#
# 1.2.4. Remove resolv.conf and create a new one
<code><span style="Color:DodgerBlue">sudo rm /etc/resolv.conf
</span></code><code><span style="Color:DodgerBlue">sudo nano /etc/resolv.conf
</span></code># Fill as below
<code><span style="Color:MediumSeaGreen">domain x11.xyz
nameserver 127.0.0.1
</span></code>#
# 1.2.5. Start DC Services
<code><span style="Color:DodgerBlue">sudo systemctl start samba-ad-dc
</span></code><code><span style="Color:DodgerBlue">sudo systemctl enable samba-ad-dc 
</span></code>#
<B><span style="Font-Family:Verdana">#--1.3. Domain is OK
</B></span># 1.3.1. Check domain level
<code><span style="Color:DodgerBlue">sudo samba-tool domain level show
</span></code>#
# 1.3.2. Create a domain user named exforge
<code><span style="Color:DodgerBlue">sudo samba-tool user create exforge
</span></code></pre> </div> </p>
<p> <H4><a href="javascript:myFunction('Div4')"> 2. Add Additional DC
</a> </H4><div id="Div4" style="margin-left:1%;"><pre ><B><span style="Font-Family:Verdana">#--2.0. Specs
</B></span># Domain Name:      X11
# Realm:            X11.xyz	
# Hostname:         srv2.x11.xyz
# IP:               192.168.1.225
# Org. DC Hostname: srv1.x11.xyz
# Org. DC IP:       192.168.1.224
#
<B><span style="Font-Family:Verdana">#--2.1. Get domain administrator's kerberos ticket
</B></span># 2.1.1. Install kerberos and edit conf
<code><span style="Color:DodgerBlue">sudo apt update
</span></code><code><span style="Color:DodgerBlue">sudo apt -y install krb5-user
</span></code># Pass all the questions with enter
<code><span style="Color:DodgerBlue">sudo nano /etc/krb5.conf 
</span></code>#   Change the beginning of the file as below
<code><span style="Color:MediumSeaGreen">&lsqb;libdefaults&rsqb;
        default_realm = X11.XYZ
        dns_lookup_realm = false
        dns_lookup_kdc = true
</span></code>#
# 2.1.2. Stop and disable systemd.resolved
# This step is not necessary for Debian 12
<code><span style="Color:DodgerBlue">sudo systemctl stop systemd-resolved
</span></code><code><span style="Color:DodgerBlue">sudo systemctl disable systemd-resolved 
</span></code>#
# 2.1.3. Remove resolv.conf and create a new one
<code><span style="Color:DodgerBlue">sudo rm /etc/resolv.conf
</span></code><code><span style="Color:DodgerBlue">sudo nano /etc/resolv.conf
</span></code>#   Add following lines
<code><span style="Color:MediumSeaGreen">domain x11.xyz
nameserver 192.168.1.224
</span></code>#
# 2.1.4. Get Kerberos ticket
# Domain Admin password will be asked (Entered at 1.2.2.)
<code><span style="Color:DodgerBlue">sudo kinit administrator
</span></code><code><span style="Color:DodgerBlue">sudo klist
</span></code>#
<B><span style="Font-Family:Verdana">#--2.2. Add This DC to Existing AD
</B></span># 2.2.1. Add necessary packages 
<code><span style="Color:DodgerBlue">sudo apt -y install samba winbind smbclient 
</span></code>#
# 2.2.2. Rename and remove default samba config, create a new one
<code><span style="Color:DodgerBlue">sudo mv /etc/samba/smb.conf /etc/samba/smb.conf.org 
</span></code><code><span style="Color:DodgerBlue">sudo samba-tool domain join X11.XYZ DC -U "srv1\administrator" --dns-backend=SAMBA_INTERNAL 
</span></code>#
# 2.2.3. Close and disable unnecessary services and enable samba
<code><span style="Color:DodgerBlue">sudo systemctl stop smbd nmbd winbind
</span></code><code><span style="Color:DodgerBlue">sudo systemctl disable smbd nmbd winbind
</span></code><code><span style="Color:DodgerBlue">sudo systemctl unmask samba-ad-dc
</span></code><code><span style="Color:DodgerBlue">sudo systemctl start samba-ad-dc
</span></code><code><span style="Color:DodgerBlue">sudo systemctl enable samba-ad-dc
</span></code>#
# 2.2.4. Verify Authentication to localhost
<code><span style="Color:DodgerBlue">sudo smbclient //127.0.0.1/netlogon -U Administrator -c 'ls'
</span></code>#
# 2.2.5. Verify replication status with AD
<code><span style="Color:DodgerBlue">sudo samba-tool drs showrepl
</span></code># Following warning is not important, you can ignore it:
#       Warning: No NC replicated for Connection!
</pre> </div> </p>
<p> <H4><a href="javascript:myFunction('Div5')"> 3. AD User Management
</a> </H4><div id="Div5" style="margin-left:1%;"><pre ># - You can run on any DC
<B><span style="Font-Family:Verdana">#-- 3.1. Display domain users list.
</B></span><code><span style="Color:DodgerBlue">sudo samba-tool user list
</span></code># 
<B><span style="Font-Family:Verdana">#-- 3.2. Add a domain user.
</B></span><code><span style="Color:DodgerBlue">sudo samba-tool user create ubuntu
</span></code># 
<B><span style="Font-Family:Verdana">#-- 3.3. Delete a domain user.
</B></span><code><span style="Color:DodgerBlue">sudo samba-tool user delete ubuntu
</span></code># 
<B><span style="Font-Family:Verdana">#-- 3.4. Reset password for a user.
</B></span><code><span style="Color:DodgerBlue">sudo samba-tool user setpassword ubuntu
</span></code># 
<B><span style="Font-Family:Verdana">#-- 3.5. Set expiration for a user.
</B></span><code><span style="Color:DodgerBlue">sudo samba-tool user setexpiry ubuntu --days=7
</span></code># 
<B><span style="Font-Family:Verdana">#-- 3.6. Disable/Enable user account.
</B></span><code><span style="Color:DodgerBlue">sudo samba-tool user disable ubuntu
</span></code><code><span style="Color:DodgerBlue">sudo samba-tool user enable ubuntu
</span></code># 
<B><span style="Font-Family:Verdana">#-- 3.7. Display domain groups list.
</B></span><code><span style="Color:DodgerBlue">sudo samba-tool group list
</span></code># 
<B><span style="Font-Family:Verdana">#-- 3.8. Display members in a group.
</B></span><code><span style="Color:DodgerBlue">sudo samba-tool group listmembers "Domain Users"
</span></code># 
<B><span style="Font-Family:Verdana">#-- 3.9. Add a domain group.
</B></span><code><span style="Color:DodgerBlue">sudo samba-tool group add ServerWorld
</span></code># 
<B><span style="Font-Family:Verdana">#-- 3.10. Delete a domain group.
</B></span><code><span style="Color:DodgerBlue">sudo samba-tool group delete ServerWorld
</span></code># 
<B><span style="Font-Family:Verdana">#-- 3.11. Add/remove a member from a domain group.
</B></span><code><span style="Color:DodgerBlue">sudo samba-tool group addmembers ServerWorld ubuntu
</span></code><code><span style="Color:DodgerBlue">sudo samba-tool group removemembers ServerWorld ubuntu
</span></code></pre> </div> </p>
<p> <H4><a href="javascript:myFunction('Div6')">4. Add Linux File Server to the Domain (Ubuntu 22.04 Server)
</a> </H4><div id="Div6" style="margin-left:1%;"><pre ><B><span style="Font-Family:Verdana">#-- 4.0. Specs
</B></span># Domain Name:      X11
# Realm:            X11.XYZ	
# Hostname:         srvf.x11.xyz
# IP:               192.168.1.226
# Org. DC Hostname: srv1.x11.xyz
# Org. DC IP:       192.168.1.224
#
<B><span style="Font-Family:Verdana">#-- 4.1. Install necessary packages
</B></span><code><span style="Color:DodgerBlue">sudo apt update
</span></code><code><span style="Color:DodgerBlue">sudo apt -y install winbind libpam-winbind libnss-winbind krb5-config samba-dsdb-modules samba-vfs-modules 
</span></code># - Answers to parameter questions:
## Default Kerberos version 5 realm:
#  X11.XYZ
## Kerberos servers for your realm:
#  srv1.x11.xyz
## Administrative server for your Kerberos realm:
#  srv1.x11.xyz
#
<B><span style="Font-Family:Verdana">#-- 4.2. Configure Winbind
</B></span># 4.2.1. Samba config
<code><span style="Color:DodgerBlue">sudo nano /etc/samba/smb.conf 
</span></code># Change/add following lines under &lsqb;global&rsqb; stanza
<code><span style="Color:MediumSeaGreen">   workgroup = X11
   realm = X11.XYZ
   security = ads
   idmap config * : backend = tdb
   idmap config * : range = 3000-7999
   idmap config X11 : backend = rid
   idmap config X11 : range = 10000-999999
   template homedir = /home/%U
   template shell = /bin/bash
   winbind use default domain = true
   winbind offline logon = false
</span></code>#
# 4.2.2. nsswitch config
<code><span style="Color:DodgerBlue">sudo nano /etc/nsswitch.conf
</span></code># Change/add following lines
<code><span style="Color:MediumSeaGreen">passwd:     compat systemd winbind
group:     compat systemd winbind
</span></code>#
# 4.2.3. pam config
<code><span style="Color:DodgerBlue">sudo nano /etc/pam.d/common-session 
</span></code>#   Add following line
<code><span style="Color:MediumSeaGreen">session optional        pam_mkhomedir.so skel=/etc/skel umask=077
</span></code>#
# 4.2.4. Change DNS to AD
# You have to change your DNS server to first DC and second DC
#
# For Ubuntu servers:
#
# !!! Ubuntu DNS Configuration BEGIN !!!
<code><span style="Color:DodgerBlue">sudo nano /etc/netplan/00-installer-config.yaml 
</span></code># If that file is not there, use the existing file instead
#   Change as below
<code><span style="Color:MediumSeaGreen">      nameservers:
        addresses: &lsqb;192.168.1.224,192.168.1.225&rsqb;
</span></code>#
# Restart network settings
<code><span style="Color:DodgerBlue">sudo netplan apply
</span></code># !!! Ubuntu DNS Configuration END !!!
#
# For Debian servers
#
# !!! Debian DNS Configuration BEGIN !!!
<code><span style="Color:DodgerBlue">sudo nano /etc/resolv.conf
</span></code># Fill as below
<code><span style="Color:MediumSeaGreen">nameserver 192.168.1.224
nameserver 192.168.1.225
</span></code>#
# !!! Debian DNS Configuration END !!!
#
<B><span style="Font-Family:Verdana">#-- 4.3. Join AD
</B></span># 4.3.1. Add this server to AD 
<code><span style="Color:DodgerBlue">sudo net ads join -U Administrator
</span></code># Restart winbind
<code><span style="Color:DodgerBlue">sudo systemctl restart winbind
</span></code>#
# 4.3.2. Show Domain Users
<code><span style="Color:DodgerBlue">sudo wbinfo -u
</span></code>#
<B><span style="Font-Family:Verdana">#-- 4.4. Config File Server
</B></span># 4.4.0. Specs
# - There will be 4 shares: 
# /srv/share1: Test1 AD Group full access
# /srv/share2: Test2 AD Group full access
# /srv/share3: Domain Users AD Group read only access
# /srv/share4: Domain Admins AD Group full access
# - I assume that these folders are created on srvf (this server)
#
# 4.4.1. Install Samba
<code><span style="Color:DodgerBlue">sudo apt -y install samba
</span></code>#
# 4.4.2. Configure samba for AD file server
<code><span style="Color:DodgerBlue">sudo nano /etc/samba/smb.conf
</span></code>#   Add following lines under &lsqb;global&rsqb;  stanza
<code><span style="Color:MediumSeaGreen">   netbios name = srvf         
   socket options = TCP_NODELAY SO_RCVBUF=16384 SO_SNDBUF=16384         
   idmap uid = 10000-20000         
   winbind enum users = yes         
   winbind gid = 10000-20000         
   os level = 20         
   winbind enum groups = yes         
   socket address = ip of your ads server         
   password server = *         
   preferred master = no         
   winbind separator = +         
   encrypt passwords = yes         
   dns proxy = no         
   wins server = 192.168.1.224         
   wins proxy = no  
</span></code>#   Add following lines at the end of the file
#     !!! Remember to change them according to your shares !!!
<code><span style="Color:MediumSeaGreen">&lsqb;share1&rsqb;         
   comment = Share1         
   path = /srv/share1         
   browseable = yes         
   read only = no         
   inherit acls = yes         
   inherit permissions = yes         
   create mask = 770         
   directory mask = 770         
   valid users = @"X11+Test1"  
   admin users = @"X11+Domain Admins"  
&lsqb;share2&rsqb;         
   comment = Share2         
   path = /srv/share2         
   browseable = yes         
   read only = no         
   inherit acls = yes         
   inherit permissions = yes         
   create mask = 770         
   directory mask = 770         
   valid users = @"X11+Test2"  
   admin users = @"X11+Domain Admins"  
&lsqb;share3&rsqb;         
   comment = Share3         
   path = /srv/share3         
   browseable = yes         
   read only = yes         
   valid users = @"X11+Domain Users"  
   admin users = @"X11+Domain Admins"  
&lsqb;share4&rsqb;         
   comment = Share4         
   path = /srv/share4         
   browseable = yes         
   read only = no         
   inherit acls = yes         
   inherit permissions = yes         
   create mask = 770         
   directory mask = 770         
   valid users = @"X11+Domain Admins"  
   admin users = @"X11+Domain Admins"  
</span></code>#
# 4.4.3. Restart Samba
<code><span style="Color:DodgerBlue">sudo systemctl restart smbd
</span></code></pre> </div> </p>
<p> <H4><a href="javascript:myFunction('Div7')">5. Add Windows Computers to the Domain 
</a> </H4><div id="Div7" style="margin-left:1%;"><pre ># - Change Windows computer's DNS setting to first DC and proceed as usual
# - AD (including the DNS server on DC) could be managed through windows 
# workstation after installing RSAT management.
# - You can connect to the file server using \\srvf\share1 (share2,3,4)
# notation from your workstation.
</pre> </div> </p>
</pre> </div> </p>
<br /><br /><br /><script>
function myFunction(divid) {
  var x = document.getElementById(divid);
  if (x.style.display === "none") {
    x.style.display = "block";
  } else {
    x.style.display = "none";
  }
}
var i;
var str;

for (i=1; i<8; i++) {
    str = "Div" + i.toString();
    myFunction(str);
}
</script></body> </html>