ADOnUbuntu: Active Directory Configuration on Ubuntu with Samba


#---Copyright (C) 2020 Exforge exforge@x386.xyz
# This document is free text: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# any later version.
# This document is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

#---Specs
# Active Directory infrastructure with Ubuntu Servers
#   Windows workstations can join to AD
#   No license costs except Windows workstation licences
# Based on the valuable documents at:
Link:https://www.server-world.info/en/note?os=Ubuntu_18.04&p=samba&f=4
# Domain Name: local.ev
# Domain Netbios Name: localdom
# First DC srv1.local.ev (Ubuntu Server 20.04)
# Second DC srv2.local.ev (Ubuntu Server 20.04)
# File Server: srvf.local.ev (Ubuntu Server 20.04)

#---Phases
# Original Document: https://www.server-world.info/en/note?os=Ubuntu_18.04&p=samba&f=4
# A. Add First DC (Ubuntu 18.04 Server or Ubuntu 20.04 Server)
# B. Add Additional DC (Ubuntu 18.04 Server or Ubuntu 20.04 Server)
# C. AD User Management
# D. Add a Linux File Server to the Domain (Ubuntu 20.04 Server)
# E. Add a Windows Computer to the Domain



#--- A. Add First Domain Controller
# 0. Specs
#   Domain Name:	localdom
#   Realm: 		local.ev	
#   Hostname:		srv1.local.ev
# 1. Install required packages
sudo apt -y install samba krb5-config winbind smbclient 
#  Answers to parameter questions:
## Default Kerberos version 5 realm:
#  local.ev
## Kerberos servers for your realm:
#  srv1.local.ev
## Administrative server for your Kerberos realm:
#  srv1.local.ev
#
# 2. Configure Samba AD DC
# 2.1. Backup original samba configuration
sudo mv /etc/samba/smb.conf /etc/samba/smb.conf.original 
# 2.2. Run Samba Config
sudo samba-tool domain provision
#  Answers to parameter questions:
## Realm:
#  local.ev
## Domain: 
#  localdom
## Server Role (dc, member, standalone) [dc]: 
#  Just press enter
## DNS backend (SAMBA_INTERNAL,...
#  Just press enter
## DNS forwarder IP address...
#  Leave empty or enter 8.8.8.8
## Administrator password:
#  Enter a good password
#
# 2.3. Copy kerberos config file, stop and disable unnecessary services
sudo cp /var/lib/samba/private/krb5.conf /etc/
sudo systemctl stop smbd nmbd winbind systemd-resolved
sudo systemctl disable smbd nmbd winbind systemd-resolved
sudo systemctl unmask samba-ad-dc 
#
# 2.4. Remove resolv.conf and create a new one
sudo rm /etc/resolv.conf
sudo nano /etc/resolv.conf
#____________________
domain local.ev
nameserver 127.0.0.1
#____________________
#
# 2.5. Start DC Services
sudo systemctl start samba-ad-dc
sudo systemctl enable samba-ad-dc 
#
# 3. Domain is OK
# 3.1. Check domain level
sudo samba-tool domain level show
# 3.2. Create a domain user
samba-tool user create exforge


#--- B. Add Additional DC
# 0. Specs
#   Domain Name:	localdom
#   Realm: 		local.ev	
#   Hostname:		srv2.local.ev
#   IP:		192.168.0.50
#   Org. DC Hostname:	srv1.local.ev
#   Org. DC IP:	192.168.0.47
# 1. Get domain administrator's kerberos ticket
# 1.1. Install kerberos and edit conf
sudo apt -y install krb5-user
# Pass all the wuestions with enter
sudo nano /etc/krb5.conf 
#   Change as below
#____________________________________
[libdefaults]
        default_realm = LOCAL.EV
        dns_lookup_realm = false
        dns_lookup_kdc = true
#____________________________________
#
# 1.2. Stop and disable systemd.resolved
sudo systemctl stop systemd-resolved
sudo systemctl disable systemd-resolved 
#
# 1.3. Remove resolv.conf and create a new one
sudo rm /etc/resolv.conf
sudo nano /etc/resolv.conf
#   Add following lines
#_____________________________________
domain local.ev
nameserver 192.168.0.47 
#_____________________________________
#
# 1.4. Get Kerberos ticket
sudo kinit administrator
sudo klist
#
# 2. Add This DC to Existing AD
# 2.1. Add necessary packages 
sudo apt -y install samba winbind smbclient 
# 2.2. Rename and remove default samba config, create a new one
sudo mv /etc/samba/smb.conf /etc/samba/smb.conf.org 
sudo samba-tool domain join local.ev DC -U "srv1\administrator" --dns-backend=SAMBA_INTERNAL 
# 2.3. Close and disable unnecessary services and enable samba
sudo systemctl stop smbd nmbd winbind
sudo systemctl disable smbd nmbd winbind
sudo systemctl unmask samba-ad-dc
sudo systemctl start samba-ad-dc
sudo systemctl enable samba-ad-dc
#
# 2.4. Verify Authentication to localhost
sudo smbclient //127.0.0.1/netlogon -U Administrator -c 'ls'
# 2.5. Verify repli,cation status with AD
sudo samba-tool drs showrepl
#   Following warning is not important you can ignore it:
#       Warning: No NC replicated for Connection!


#--- C. AD User Management
# 1. Display domain users list.
sudo samba-tool user list
# 
# 2. Add a domain user.
sudo samba-tool user create ubuntu
# 
# 3. Delete a domain user.
sudo samba-tool user delete ubuntu
# 
# 4. Reset password for a user.
sudo samba-tool user setpassword ubuntu
# 
# 5. Set expiry for a user.
sudo samba-tool user setexpiry ubuntu --days=7
# 
# 6. Disable/Enable user account.
sudo samba-tool user disable ubuntu
sudo samba-tool user enable ubuntu
# 
# 7. Display domain groups list.
sudo samba-tool group list
# 
# 8. Display members in a group.
sudo samba-tool group listmembers "Domain Users"
# 
# 9. Add a domain group.
sudo samba-tool group add ServerWorld
# 
# 10. Delete a domain group.
sudo samba-tool group delete ServerWorld
# 
# 11. Add/remove a member from a domain group.
sudo samba-tool group addmembers ServerWorld ubuntu
sudo samba-tool group removemembers ServerWorld ubuntu


#--- D. Add Linux File Server to the Domain (Ubuntu 20.04 Server)
# 0. Specs
#   Domain Name:	localdom
#   Realm: 		local.ev	
#   Hostname:		srvf.local.ev
#   IP:		192.168.0.18
#   Org. DC Hostname:	srv1.local.ev
#   Org. DC IP:	192.168.0.47
# 1. Install necessary packages
sudo apt -y install winbind libpam-winbind libnss-winbind krb5-config samba-dsdb-modules samba-vfs-modules 
#  Answers to parameter questions:
## Default Kerberos version 5 realm:
#  local.ev
## Kerberos servers for your realm:
#  srv1.local.ev
## Administrative server for your Kerberos realm:
#  srv1.local.ev
#
# 2. Configure Winbind
# 2.1. Samba config
sudo nano /etc/samba/smb.conf 
#   Change/add following lines under [global] stanza
#___________________________________________
   workgroup = LOCALDOM
   realm = LOCAL.EV
   security = ads
   idmap config * : backend = tdb
   idmap config * : range = 3000-7999
   idmap config LOCALDOM : backend = rid
   idmap config LOCALDOM : range = 10000-999999
   template homedir = /home/%U
   template shell = /bin/bash
   winbind use default domain = true
   winbind offline logon = false
#___________________________________________
#
# 2.2. nsswitch config
sudo nano /etc/nsswitch.conf
#   Change/add following lines
#___________________________________________
passwd:     compat systemd winbind
group:     compat systemd winbind
#___________________________________________
#
# 2.3. pam config
sudo nano /etc/pam.d/common-session 
#   Add following line
#___________________________________________
session optional        pam_mkhomedir.so skel=/etc/skel umask=077
#___________________________________________
#
# 2.4. Change DNS to AD
#   You have to change your DNS server to first DC and second DC
sudo nano /etc/netplan/01-netcfg.yaml 
#   Change as below
#____________________________________________
      nameservers:
        addresses: [10.0.0.100]
#____________________________________________
#
# 2.5. Restart network settings
sudo netplan apply
#
# 3. Join AD
# 3.1. Add this server to AD
sudo net ads join -U Administrator
# !!! About DNS Update Error !!!
#   In my implementation I had an DNS Update Error message at this phase.
#   I don't know why it happenned, but it means there is a problem with
#      dynamic dns update, and srvf cannot be added to the DNS. 
#   I will investigate this situation but there is a workaround to add 
#      srvf to DNS in srv1 manually by using a windows workstation.
#
# 3.2. Show Domain Users
sudo wbinfo -u
#   In case of error restart winbind
#   sudo systemctl restart winbind
#
# 4. Config File Server
# 4.0. Specs
#   There will be 4 shares: 
#     /srv/share1: Test1 AD Group full access
#     /srv/share2: Test2 AD Group full access
#     /srv/share3: Domain Users AD Group read only access
#     /srv/share4: Domain Admins AD Group full access
#   I assume that these folders are created on srvf (this server)
#
# 4.1. Install Samba
sudo apt -y install samba
# 4.2. Configure samba for AD file server
sudo nano /etc/samba/smb.conf
#   Add following lines under [global]  stanza
#___________________________________________________________________
	netbios name = srvf         
	socket options = TCP_NODELAY SO_RCVBUF=16384 SO_SNDBUF=16384         
	idmap uid = 10000-20000         
	winbind enum users = yes         
	winbind gid = 10000-20000         
	os level = 20         
	winbind enum groups = yes         
	socket address = ip of your ads server         
	password server = *         
	preferred master = no         
	winbind separator = +         
	encrypt passwords = yes         
	dns proxy = no         
	wins server = 192.168.0.47         
	wins proxy = no  
#___________________________________________________________________
#   Add following lines at the end of the file
#     !!! Remember to change them according to your shares !!!
#___________________________________________________________________
[share1]         
	comment = Share1         
	path = /srv/share1         
	browseable = yes         
	read only = no         
	inherit acls = yes         
	inherit permissions = yes         
	create mask = 770         
	directory mask = 770         
	valid users = @"LOCALDOM+Test1"  
	admin users = @"LOCALDOM+Domain Admins"  
[share2]         
	comment = Share2         
	path = /srv/share2         
	browseable = yes         
	read only = no         
	inherit acls = yes         
	inherit permissions = yes         
	create mask = 770         
	directory mask = 770         
	valid users = @"LOCALDOM+Test2"  
	admin users = @"LOCALDOM+Domain Admins"  
[share3]         
	comment = Share3         
	path = /srv/share3         
	browseable = yes         
	read only = yes         
	valid users = @"LOCALDOM+Domain Users"  
	admin users = @"LOCALDOM+Domain Admins"  
[share4]         
	comment = Share4         
	path = /srv/share4         
	browseable = yes         
	read only = no         
	inherit acls = yes         
	inherit permissions = yes         
	create mask = 770         
	directory mask = 770         
	valid users = @"LOCALDOM+Domain Admins"  
	admin users = @"LOCALDOM+Domain Admins"  
#___________________________________________________________________
# 4.3. Restart Samba
sudo systemctl restart smbd

#--- E. Add Windows Computer to the Domain 
# 1. Change Windows computer's DNS setting to first DC
#    and proceed as usual
# 2. AD (including the DNS server on DC) could be managed through windows 
#    workstation after installing RSAT management.




